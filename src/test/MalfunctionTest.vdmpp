class MalfunctionTest is subclass of Test

operations
		public createMalfunction: User*Printer ==> Malfunction
 		createMalfunction(user, printer) ==
 		(
 				dcl malf:Malfunction;
				malf := user.reportMalfunction(printer,<Paper>,"problema");		
				return malf;
		);
		
		public createClient: () ==> Client
 		createClient() ==
 		(
 			dcl manager:PrintManager;
 			dcl cli:Client;
 			manager := PrintManager`getInstance();
 			cli := manager.addClient("utilizador","12345678",10.0);
 			return cli;
 		);
 		
 		
 	public createEmployee: () ==> Employee
 		createEmployee() ==
 		(
 			dcl manager:PrintManager;
 			dcl emp:Employee;
 			dcl empCreated: bool;
 			dcl admin: Employee;
 			manager := PrintManager`getInstance();
 			admin := manager.login("admin", "admin");
 			empCreated := manager.addEmployee("empregado","emp12345",<Regular>);
 			assertTrue(empCreated);
 			PrintManager`getInstance().logout();
 			emp := manager.login("empregado", "emp12345");
 			return emp;
 		);
 		
 	 	public createPrinterAndQueue: () ==> Printer
	 		createPrinterAndQueue() ==
	 		(
	 				dcl queues: set of Queue := {};
	 				dcl printer: Printer;
	 				queues:= queues union {PrintManager`getInstance().addQueue(<A4>,<BlackWhite>)};
	 				printer := PrintManager`getInstance().addPrinter(0,"trabalho", queues);
	 				return printer;
	 				
	 		);
		-- Normal scenario for creating a function
		-- as described in section 1.2 of the report, covering requirement R7.	
		public testMalfunction: () ==> ()
			testMalfunction() ==
			(
				dcl cli: Client;
				dcl emp: Employee;
				dcl printer:Printer;
				dcl malf: Malfunction;
				PrintManager`clearInstance();
				IO`print("Test Malfunction - create\n");
				emp := createEmployee();
				printer := createPrinterAndQueue();
				PrintManager`getInstance().logout();
				cli := createClient();
				malf := createMalfunction(cli, printer);
				assertEqual(malf.getState(), <Waiting>);
				assertEqual(malf.getReportedBy(),cli);
				assertEqual(malf.getPrinter(), printer);
				assertEqual(malf.getProblem(), <Paper>);
				assertEqual(malf.getDescription(), "problema");
			);
		
		-- Normal scenario for assigning an employee/admin to this malfunction
		-- as described in section 1.2 of the report, covering requirement R18.		
		public testAssignEmployee: () ==> ()
			testAssignEmployee() ==
			(
				dcl cli: Client;
				dcl emp: Employee;
				dcl admin: Employee;
				dcl printer:Printer;
				dcl malf: Malfunction;
				dcl malf2: Malfunction;
				PrintManager`clearInstance();
				IO`print("Test Malfunction - assign Employee\n");
				emp := createEmployee();
				printer := createPrinterAndQueue();
				PrintManager`getInstance().logout();
				cli := createClient();
				malf := createMalfunction(cli, printer);
				malf2 := cli.reportMalfunction(printer,<Toner>,"toner empty");		
				PrintManager`getInstance().logout();
				admin := PrintManager`getInstance().login("admin","admin");
				malf.assignEmployee(emp);
				malf2.assignEmployee(emp);
				assertEqual(malf.getAssignedBy(), admin);
				assertEqual(malf.getAssignedTo(), emp);
				assertEqual(malf.getState(), <InRepair>);
				assertEqual(malf.getReportedBy(), cli);
				assertEqual(malf.getPrinter(), printer);
				assertEqual(malf.getProblem(), <Paper>);
				assertEqual(malf.getDescription(), "problema");
				malf2.changeState(<Fixed>);
				assertEqual(malf2.getState(), <Fixed>);
				PrintManager`getInstance().logout();
				emp:=PrintManager`getInstance().login("empregado","emp12345");
				assertEqual(malf.getAssignedBy(), admin);
				assertEqual(malf.getAssignedTo(), emp);
				assertEqual(malf.getReportedBy(), cli);
				assertEqual(malf.getPrinter(), printer);
				assertEqual(malf.getProblem(), <Paper>);
				assertEqual(malf.getDescription(), "problema");
				
			);	
			
		public test: () ==> ()
			test() ==
			(
				testMalfunction();
				testAssignEmployee();
			)

end MalfunctionTest